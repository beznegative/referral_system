# Руководство по месячному учету выплат

## Обзор изменений

Система была обновлена для поддержки месячного учета выплат. Теперь вы можете:

1. Отслеживать общие выплаты (всего за все время)
2. Отслеживать месячные выплаты (за конкретный месяц)
3. Архивировать данные по месяцам
4. Генерировать PDF отчеты за любой месяц

## Новые поля в системе

### В таблице пользователей:
- **Всего выплачено в рублях** (`total_paid_amount`) - общая сумма выплат за все время
- **Всего выплачено за рефералов** (`total_paid_for_referrals`) - общая сумма выплат за рефералов за все время
- **Выплачено в рублях за месяц** (`monthly_paid_amount`) - сумма выплат за текущий месяц
- **Выплачено за рефералов за месяц** (`monthly_paid_for_referrals`) - сумма выплат за рефералов за текущий месяц
- **Месяц учета выплат** (`payment_month`) - месяц, к которому относятся текущие месячные выплаты

## Как использовать новый функционал

### 1. Редактирование пользователя

При редактировании пользователя в форме теперь доступны поля:
- Всего выплачено в рублях
- Всего выплачено за рефералов
- Месяц учета выплат (выбор месяца)
- Выплачено в рублях за месяц
- Выплачено за рефералов за месяц

### 2. Просмотр информации о пользователе

На странице пользователя отображается:
- Общая информация о всех выплатах
- Детализация выплат за текущий месяц
- Реферальная информация с разбивкой по уровням

### 3. Архивирование месяца

В разделе **Настройки → Месячные отчеты** доступно:

#### Архивирование месяца:
1. Выберите месяц для архивирования
2. Нажмите "Архивировать месяц"
3. Система сохранит все месячные данные в архив
4. Месячные счетчики будут обнулены
5. Месяц учета сменится на текущий

### 4. Генерация PDF отчетов

#### Для создания отчета:
1. Перейдите в **Настройки → Месячные отчеты**
2. Выберите месяц для отчета
3. Нажмите "Скачать PDF отчет"
4. Откроется страница с отчетом
5. Используйте кнопку "Печать / Сохранить PDF" для сохранения

#### Содержание PDF отчета:
- Статистика за месяц (общие суммы, количество партнеров/пользователей)
- Детальная таблица всех выплат
- Разделение на партнеров и пользователей
- Итоговые суммы

## Рабочий процесс

### Ежемесячный цикл:

1. **В течение месяца**: вводите выплаты в поля "за месяц"
2. **В конце месяца**: 
   - Сгенерируйте PDF отчет за месяц
   - Архивируйте месяц (данные сохранятся в архив, счетчики обнулятся)
3. **Новый месяц**: начинайте вводить новые выплаты

### Пример использования:

```
Январь 2025:
- Пользователь А: выплачено за месяц 5000₽
- Партнер Б: выплачено за рефералов за месяц 2500₽

31 января:
1. Генерируем отчет за январь (PDF)
2. Архивируем январь
3. Система обнуляет месячные счетчики
4. Устанавливает месяц учета = "2025-02"

Февраль 2025:
- Начинаем вводить новые выплаты за февраль
```

## Важные особенности

1. **Автоматический пересчет**: при изменении общих выплат автоматически пересчитываются выплаты партнерам
2. **История сохраняется**: архивные данные не удаляются, их можно просматривать в любое время
3. **Гибкость отчетов**: можно генерировать отчеты как за текущий месяц, так и за любой архивный
4. **Безопасность**: все операции выполняются в транзакциях с откатом при ошибках

## Технические детали

### Новая таблица `monthly_payments`:
- Хранит архивные данные по месяцам
- Уникальный индекс по (user_id, payment_month)
- Автоматическое обновление при архивировании

### Обновленные функции:
- Все расчеты реферальной системы используют `total_paid_amount`
- PDF генерация объединяет текущие и архивные данные
- Формы обновлены для работы с новыми полями

## Миграция данных

Если у вас уже были данные в старых полях (`paid_amount`, `paid_for_referrals`), они были автоматически переименованы в новые поля (`total_paid_amount`, `total_paid_for_referrals`) при обновлении системы.

## Поддержка

При возникновении проблем проверьте:
1. Структуру базы данных (все новые поля должны присутствовать)
2. Права доступа к таблицам
3. Корректность заполнения поля `payment_month` (формат YYYY-MM) 