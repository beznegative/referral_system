# Реализация системы месячных выплат

## Что было добавлено

Система теперь поддерживает сохранение и отображение выплат по месяцам и годам.

### 1. Изменения в форме пользователя (`user_form.php`)

- **Добавлено поле "Год выплат"** - выпадающий список с годами (текущий год ± 2 года)
- **Изменено поле "Месяц выплат"** - теперь выпадающий список с названиями месяцев на русском языке
- **Автоматическое обновление данных** - при смене года или месяца поля выплат автоматически загружаются из базы данных

### 2. API для получения данных (`get_monthly_data.php`)

Новый файл, который обрабатывает AJAX-запросы для получения данных по выбранному месяцу и году:
- Получает данные из таблицы `monthly_payments`
- Рассчитывает общие суммы на основе всех месяцев
- Возвращает данные в JSON формате

### 3. Обновленная логика сохранения (`save_user.php`)

- **Корректное объединение года и месяца** - данные из отдельных полей объединяются в формат YYYY-MM
- **Автоматическое сохранение в `monthly_payments`** - все месячные данные сохраняются в отдельную таблицу
- **Пересчёт общих сумм** - поля "Всего выплачено" рассчитываются как сумма всех месяцев

### 4. JavaScript функциональность

- **Автоматическая загрузка данных** при смене года или месяца
- **Валидация формы** с учётом новых полей
- **Индикаторы загрузки** для улучшения пользовательского опыта

## Как это работает

### Пример использования:

1. **Пользователь выбирает "Июль 2025"**:
   - Поля "Выплачено за месяц" и "Выплачено за рефералов за месяц" показывают данные за июль 2025
   - Поля "Всего выплачено" показывают сумму всех месяцев

2. **Пользователь вводит: Июль 2025 - 5000₽ и 1000₽**:
   - Данные сохраняются в таблицу `monthly_payments`
   - Общие суммы пересчитываются

3. **Пользователь переключается на "Август 2025"**:
   - Поля обнуляются (если нет данных за август)
   - Общие суммы остаются теми же

4. **Пользователь возвращается к "Июль 2025"**:
   - Поля автоматически заполняются: 5000₽ и 1000₽
   - Данные сохранены и восстановлены

## Структура базы данных

Используется существующая таблица `monthly_payments`:

```sql
CREATE TABLE `monthly_payments` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `payment_month` varchar(7) NOT NULL COMMENT 'Месяц в формате YYYY-MM',
  `paid_amount` decimal(10,2) DEFAULT 0.00 COMMENT 'Выплачено в рублях за месяц',
  `paid_for_referrals` decimal(10,2) DEFAULT 0.00 COMMENT 'Выплачено за рефералов за месяц',
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id`),
  UNIQUE KEY `user_month` (`user_id`, `payment_month`)
)
```

## Тестирование

Для проверки работы системы создан файл `test_monthly_system.php`, который:
- Тестирует API получения данных
- Проверяет структуру таблицы `monthly_payments`
- Отображает существующие данные

Запустить тест можно через браузер: `http://localhost/referral_system_act/test_monthly_system.php`

## Основные преимущества

1. **Сохранение истории** - все данные по месяцам сохраняются
2. **Быстрое переключение** - между месяцами без потери данных
3. **Автоматический расчёт** - общих сумм на основе всех месяцев
4. **Удобный интерфейс** - с отдельными полями для года и месяца
5. **AJAX-обновления** - без перезагрузки страницы

## Файлы, которые были изменены

- `user_form.php` - основная форма пользователя
- `save_user.php` - логика сохранения данных
- `get_monthly_data.php` - новый API файл
- `test_monthly_system.php` - тестовый файл
