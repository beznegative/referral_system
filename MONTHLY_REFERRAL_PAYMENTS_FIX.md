# Исправление системы месячных выплат за рефералов

## Проблема
Ранее при изменении месячных выплат пользователя не пересчитывались месячные выплаты за рефералов для его партнёров. Например:
- Пользователь "Первый" получил 10000₽ в августе 2025
- Его пригласил "Админ" (40% с первого уровня)
- У "Админа" должно было стать 4000₽ в поле "Выплачено за рефералов за месяц" за август 2025
- Но изменялось только поле "Всего выплачено за рефералов"

## Решение

### 1. Создана новая функция `updateMonthlyAffiliatePayments()`

**Файл:** `referral_calculator.php`

Функция пересчитывает все месячные выплаты за рефералов для конкретного месяца:
- Сбрасывает все месячные выплаты за рефералов для указанного месяца
- Получает всех пользователей с выплатами за этот месяц
- Для каждого пользователя проходит по цепочке партнёров (до 3 уровней)
- Рассчитывает выплаты согласно процентам (40%, 25%, 10%)
- Обновляет данные в таблицах `monthly_payments` и `users`

### 2. Интегрирована в `save_user.php`

Добавлен вызов функции `updateMonthlyAffiliatePayments($pdo, $payment_month)` после сохранения данных в `monthly_payments` для:
- Обновления существующих пользователей
- Создания новых пользователей с выплатами

### 3. Обновлён `get_monthly_data.php`

Улучшена логика расчёта общих сумм с учётом всех данных из `monthly_payments`.

## Как это работает теперь

### Пример:
1. **Пользователь "Первый" получает 10000₽ в августе 2025**
   - Сохраняется в `monthly_payments` запись: user_id=29, payment_month='2025-08', paid_amount=10000, paid_for_referrals=0

2. **Автоматически вызывается `updateMonthlyAffiliatePayments($pdo, '2025-08')`**
   - Находит, что "Первый" привязан к "Админу" (уровень 1)
   - Рассчитывает: 10000 × 40% = 4000₽
   - Обновляет/создаёт запись для "Админа": payment_month='2025-08', paid_for_referrals=4000

3. **Результат:**
   - У "Первого": 10000₽ за месяц, 0₽ за рефералов
   - У "Админа": 0₽ за месяц, 4000₽ за рефералов в августе 2025

### При переключении месяцев:
- **Август 2025**: Админ видит 4000₽ за рефералов
- **Сентябрь 2025**: Админ видит 0₽ за рефералов (если нет данных)
- **Обратно в август 2025**: Админ снова видит 4000₽ за рефералов

## Файлы изменены:
- `referral_calculator.php` - добавлена функция `updateMonthlyAffiliatePayments()`
- `save_user.php` - добавлены вызовы новой функции
- `get_monthly_data.php` - улучшена логика расчёта общих сумм

## Преимущества:
1. **Корректный расчёт месячных выплат за рефералов**
2. **Сохранение истории по месяцам** 
3. **Автоматическое обновление** при изменении данных пользователя
4. **Поддержка многоуровневой структуры** (до 3 уровней)
5. **Консистентность данных** между таблицами `users` и `monthly_payments`
