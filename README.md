# Реферальная система

## Описание

Реферальная система для управления партнерами и рефералами с трёхуровневой структурой выплат. Система предназначена для букмекерских контор и включает в себя управление пользователями, партнерами, автоматический расчет выплат и интеграцию с Telegram.

## Как работает реферальная система

### Структура уровней

Система работает по принципу многоуровневого маркетинга с тремя уровнями:

- **1 уровень**: Прямые рефералы партнера - **50%** от выплаченной суммы
- **2 уровень**: Рефералы рефералов - **25%** от выплаченной суммы
- **3 уровень**: Рефералы третьего уровня - **10%** от выплаченной суммы

### Принцип работы

1. **Партнер** (`is_affiliate = 1`) приглашает пользователей
2. Когда пользователь регистрируется, он указывает ID партнера в поле `affiliate_id`
3. При изменении поля `paid_amount` у пользователя автоматически пересчитываются выплаты для всех партнеров в цепочке
4. Выплаты сохраняются в таблицу `referral_earnings`
5. Поле `paid_for_referrals` у партнера автоматически обновляется

### Пример расчета

Если пользователь заработал 10 000 рублей:
- Партнер 1 уровня получит: 10 000 × 50% = **5 000 рублей**
- Партнер 2 уровня получит: 10 000 × 25% = **2 500 рублей**
- Партнер 3 уровня получит: 10 000 × 10% = **1 000 рублей**

## Структура базы данных

### Основные таблицы

#### `users`
- `id` - уникальный идентификатор
- `full_name` - полное имя пользователя
- `bank_card` - зашифрованный номер банковской карты
- `telegram_username` - имя пользователя в Telegram
- `telegram_id` - ID в Telegram
- `phone_number` - номер телефона
- `birth_date` - дата рождения
- `is_affiliate` - является ли пользователь партнером (0/1)
- `affiliate_id` - ID партнера, пригласившего пользователя
- `paid_amount` - выплаченная сумма в рублях
- `paid_for_referrals` - выплаченная сумма за рефералов
- `referral_count` - количество рефералов

#### `referral_earnings`
- `id` - уникальный идентификатор
- `affiliate_id` - ID партнера
- `referral_id` - ID реферала
- `level` - уровень (1, 2 или 3)
- `earning` - сумма выплаты

#### `referral_settings`
- `setting_name` - название настройки
- `setting_value` - значение в процентах
- `description` - описание

#### `bookmakers`
- `id` - уникальный идентификатор
- `name` - название букмекерской конторы
- `code` - код конторы

#### `user_bookmakers`
- `user_id` - ID пользователя
- `bookmaker_id` - ID букмекерской конторы

### Настройки процентов

Проценты выплат настраиваются в таблице `referral_settings`:

```sql
INSERT INTO referral_settings (setting_name, setting_value, description) VALUES 
('level_1_percent', 50.00, 'Процент для рефералов 1 уровня'),
('level_2_percent', 25.00, 'Процент для рефералов 2 уровня'),
('level_3_percent', 10.00, 'Процент для рефералов 3 уровня');
```

## Основные файлы

### Пользовательские интерфейсы
- `index.php` - главная страница со списком пользователей и партнеров
- `user.php` - детальная страница пользователя с информацией о рефералах
- `user_form.php` - форма добавления/редактирования пользователя
- `settings.php` - панель администратора с настройками системы

### Логика реферальной системы
- `referral_calculator.php` - основная логика расчета выплат
- `save_user.php` - сохранение пользователей и автоматический пересчет выплат
- `update_referral_counts.php` - обновление счетчиков рефералов

### Интеграция с Telegram
- `telegram_api.php` - класс для работы с Telegram Bot API
- `check_telegram_setup.php` - проверка настроек Telegram

### Безопасность
- `test_encryption.php` - функции шифрования/дешифрования банковских карт
- `reencrypt_cards.php` - пересшифровка карт при смене ключа

## Функции системы

### Основные возможности
1. **Управление пользователями**
   - Добавление/редактирование пользователей
   - Привязка к партнерам
   - Выбор букмекерских контор

2. **Реферальная система**
   - Автоматический расчет выплат по 3 уровням
   - Настройка процентов выплат
   - Пересчет всех выплат в системе

3. **Интеграция с Telegram**
   - Отправка сообщений всем партнерам
   - Отправка фотографий с подписями
   - Проверка статуса бота

4. **Безопасность**
   - Шифрование банковских карт
   - Защищенное хранение данных

5. **Панель администратора**
   - Статистика по пользователям и партнерам
   - Управление настройками
   - Массовые операции

### Автоматические процессы
- При изменении `paid_amount` у пользователя автоматически пересчитываются выплаты для всех партнеров в цепочке
- Обновление поля `paid_for_referrals` у партнеров
- Ведение истории выплат в таблице `referral_earnings`

## Установка и настройка

### Требования
- PHP 7.4 или выше
- MySQL 5.7 или выше
- Расширения PHP: PDO, OpenSSL, cURL

### Установка
1. Клонировать репозиторий
2. Импортировать `database.sql` в базу данных
3. Настроить подключение к БД в `includes/database.php`
4. Настроить Telegram бота (токен в таблице `api_tokens`)
5. Установить правильные права на папку `uploads/`

### Настройка Telegram бота
1. Создать бота через @BotFather
2. Получить токен
3. Добавить токен в таблицу `api_tokens`:
```sql
INSERT INTO api_tokens (token_name, token_value, description) 
VALUES ('telegram_bot_token', 'YOUR_BOT_TOKEN', 'Токен для Telegram бота');
```

## Безопасность

### Шифрование данных
- Банковские карты шифруются с помощью AES-256-CBC
- Ключ шифрования настраивается в `ENCRYPTION_KEY`
- Для пересшифровки карт используется `reencrypt_cards.php`

### Рекомендации
- Регулярно обновляйте ключ шифрования
- Используйте HTTPS для работы с системой
- Ограничьте доступ к файлам настроек
- Делайте регулярные резервные копии БД

## API функции

### Основные классы и функции

#### `referral_calculator.php`
- `getReferralSettings($pdo)` - получение настроек процентов
- `calculateReferralEarnings($pdo, $userId)` - расчет выплат для партнера
- `updateAffiliatePayments($pdo, $userId)` - обновление выплат при изменении суммы
- `recalculateAllReferralPayments($pdo)` - полный пересчет всех выплат

#### `TelegramAPI`
- `sendMessage($chat_id, $text)` - отправка сообщения
- `sendPhoto($chat_id, $photo, $caption)` - отправка фото
- `sendMessageToAll($text)` - отправка сообщения всем партнерам

## Лицензия

Все права защищены. Использование системы разрешено только с согласия автора.

## Поддержка

Для получения технической поддержки обращайтесь к разработчику системы. 