# Система капчи для реферальной системы (v2.0 с reCAPTCHA)

## Описание

Обновленная система капчи с поддержкой Google reCAPTCHA v2 для профессиональной защиты от автоматизированных запросов и ботов. Система поддерживает как простую капчу с галочкой "Я не робот", так и полноценную Google reCAPTCHA.

## Как это работает

### Для пользователей

1. При переходе на `miniapp.php` или `test_miniapp.php` пользователь сначала увидит страницу с капчей
2. Нужно поставить галочку "Я не робот" 
3. Нажать кнопку "Продолжить"
4. После успешной проверки пользователь перенаправляется на целевую страницу

### Технические детали

- **Файлы капчи:**
  - `captcha.php` - универсальная страница с капчей (простая + reCAPTCHA)
  - `captcha_config.php` - конфигурация системы капчи
  - `verify_captcha.php` - обработка верификации (поддержка reCAPTCHA)
  - `check_captcha.php` - функции для проверки статуса капчи
  - `test_captcha_system.php` - расширенная тестовая панель
  - `clear_captcha_session.php` - очистка сессии
  - `check_captcha_installation.php` - скрипт проверки установки

- **Защищенные страницы:**
  - `miniapp.php` - основное приложение
  - `test_miniapp.php` - тестовая версия
  - `check_user_api.php` - API проверки пользователя
  - `get_affiliates_api.php` - API списка партнеров
  - `register_api.php` - API регистрации

## Особенности

### Безопасность
- Капча действует 30 минут
- Проверка IP адреса
- Логирование всех попыток
- Защита от CSRF атак

### Пользовательский опыт
- Красивый современный дизайн
- Анимации и переходы
- Адаптивный интерфейс
- Поддержка Telegram WebApp тем

## Прямые URL для доступа

- **Обычное приложение:** `captcha.php?target=miniapp` → перенаправит на `miniapp.php`
- **Тестовое приложение:** `captcha.php?target=test` → перенаправит на `test_miniapp.php`

## Файлы логов

Система создает логи в папке `logs/`:
- `captcha_verifications.log` - успешные верификации
- `captcha_errors.log` - ошибки при проверке

## Отключение капчи (для разработки)

Чтобы временно отключить капчу, закомментируйте строки проверки в соответствующих файлах:

```php
// require_once 'check_captcha.php';
// requireCaptcha('miniapp');
```

## Настройка времени действия

В файле `verify_captcha.php` можно изменить время действия капчи:

```php
// Капча действительна в течение 30 минут (1800 секунд)
$_SESSION['captcha_expires'] = $currentTime + (30 * 60);
```

## Устранение неполадок

1. **Капча не работает:**
   - Проверьте права на запись в папку `logs/`
   - Убедитесь, что сессии PHP работают корректно

2. **Постоянные перенаправления:**
   - Очистите cookies браузера
   - Проверьте настройки сессий PHP

3. **API возвращает ошибку 403:**
   - Сначала пройдите капчу на веб-странице
   - Проверьте актуальность сессии

## Настройка Google reCAPTCHA

### Быстрый старт с reCAPTCHA

1. **Получите ключи:**
   - Идите на https://www.google.com/recaptcha/admin/create
   - Создайте сайт с типом "reCAPTCHA v2" → "Галочка Я не робот"
   - Добавьте ваши домены

2. **Обновите конфигурацию:**
   ```php
   // В captcha_config.php
   define('CAPTCHA_TYPE', 'recaptcha');
   define('RECAPTCHA_SITE_KEY', 'ваш_site_key');
   define('RECAPTCHA_SECRET_KEY', 'ваш_secret_key');
   ```

3. **Проверьте установку:**
   - Откройте `check_captcha_installation.php`
   - Или запустите: `php check_captcha_installation.php`

### Переключение между типами капчи

```php
// Простая капча
define('CAPTCHA_TYPE', 'simple');

// Google reCAPTCHA  
define('CAPTCHA_TYPE', 'recaptcha');
```

## Тестирование и диагностика

- **`test_captcha_system.php`** - полная панель диагностики
- **`check_captcha_installation.php`** - проверка правильности установки
- Логи в папке `logs/` с подробной информацией

## Дополнительная информация

Система автоматически адаптируется под тему Telegram WebApp, поддерживает как простую капчу, так и профессиональную Google reCAPTCHA, и выглядит современно на всех устройствах.

**Документация:**
- `RECAPTCHA_SETUP.md` - подробная настройка reCAPTCHA
- `CAPTCHA_SYSTEM_README.md` - полная документация системы
- `CAPTCHA_USAGE.md` - инструкции по использованию 