# 3-уровневая реферальная система

## Описание

Добавлена 3-уровневая реферальная система с настраиваемыми процентами выплат:
- **1 уровень**: 50% (по умолчанию)
- **2 уровень**: 25% (по умолчанию)
- **3 уровень**: 10% (по умолчанию)

## Установка

### 1. Обновление базы данных

Выполните следующие SQL-команды в вашей базе данных:

```sql
-- Создание таблицы настроек реферальной системы
CREATE TABLE IF NOT EXISTS referral_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_name VARCHAR(50) NOT NULL UNIQUE,
    setting_value DECIMAL(5,2) NOT NULL,
    description VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Вставка настроек по умолчанию
INSERT INTO referral_settings (setting_name, setting_value, description) VALUES 
('level_1_percent', 50.00, 'Процент для рефералов 1 уровня'),
('level_2_percent', 25.00, 'Процент для рефералов 2 уровня'),
('level_3_percent', 10.00, 'Процент для рефералов 3 уровня')
ON DUPLICATE KEY UPDATE setting_value = VALUES(setting_value);

-- Если поля paid_amount и paid_for_referrals не существуют, добавьте их:
ALTER TABLE users ADD COLUMN paid_amount DECIMAL(10,2) DEFAULT 0.00;
ALTER TABLE users ADD COLUMN paid_for_referrals DECIMAL(10,2) DEFAULT 0.00;
```

### 2. Новые файлы

Убедитесь, что в проекте есть файл `referral_calculator.php` с функциями для расчета выплат.

## Функциональность

### Для администратора (settings.php)

1. **Настройка процентов**: Перейдите в раздел "Настройки реферальной системы"
2. **Изменение процентов**: Введите новые значения для каждого уровня (от 0 до 100%)
3. **Сохранение**: Нажмите "Сохранить настройки"

### Для пользователей (user.php)

**Только для партнеров** отображается:

1. **Таблица выплат по уровням**:
   - Уровень реферала
   - Процент выплаты
   - Сумма к выплате

2. **Детальная информация о рефералах**:
   - Имя реферала
   - Уровень (1, 2 или 3)
   - Выплаченная сумма реферала
   - Процент для расчета
   - Сумма к получению

## Логика работы

### Расчет выплат

1. **1 уровень**: Прямые рефералы партнера
2. **2 уровень**: Рефералы рефералов 1 уровня
3. **3 уровень**: Рефералы рефералов 2 уровня

### Формула расчета

```
Выплата = Сумма_выплат_реферала × (Процент_уровня / 100)
```

### Пример расчета

Если у партнера есть:
- Реферал 1 уровня с выплатами 1000₽
- Реферал 2 уровня с выплатами 500₽
- Реферал 3 уровня с выплатами 200₽

При процентах 50%, 25%, 10%:
- За 1 уровень: 1000 × 0.5 = 500₽
- За 2 уровень: 500 × 0.25 = 125₽
- За 3 уровень: 200 × 0.1 = 20₽
- **Итого**: 645₽

## Функции в referral_calculator.php

- `getReferralSettings($pdo)` - получение настроек процентов
- `getReferralsByLevels($pdo, $userId, $maxLevel)` - получение рефералов по уровням
- `calculateReferralEarnings($pdo, $userId)` - расчет выплат по уровням
- `getReferralDetails($pdo, $userId)` - детальная информация о рефералах
- `updateReferralSettings($pdo, $level1, $level2, $level3)` - обновление настроек

## Стили

Добавлены CSS-стили для:
- Таблиц реферальной системы
- Формы настроек
- Адаптивного дизайна для мобильных устройств
- Цветовых схем для различных уровней

## Безопасность

- Проверка значений процентов (0-100%)
- Использование подготовленных SQL-запросов
- Обработка ошибок и транзакций
- Экранирование HTML-вывода

## Использование

1. Настройте проценты в разделе "Настройки системы"
2. Просматривайте выплаты партнеров в их профилях
3. Система автоматически рассчитывает выплаты на основе текущих настроек

## Поддержка

При возникновении проблем:
1. Проверьте корректность SQL-запросов
2. Убедитесь, что все файлы загружены
3. Проверьте права доступа к базе данных
4. Обратитесь к логам ошибок PHP 